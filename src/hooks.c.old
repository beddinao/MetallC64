#include "metallc64.h"

void	close_hook(void *p) {
	(void)p;
	exit_handle(0);
}

void	resize_hook(int w, int h, void *p) {
	(void)h;
	_bus *bus = (_bus*)p;
	pthread_mutex_lock(&bus->t_data->prg_mutex);
	_VIC_II *vic = (_VIC_II*)bus->vic;
	float new_wpd = (float)w / (float)GWIDTH;
	if (new_wpd != vic->wpdx) {
		vic->win_width = w;
		vic->wpdx = new_wpd;
		vic->wpdy = vic->wpdx;
		vic->win_height = vic->win_width * HTOW;
		mlx_resize_image(vic->mlx_img, vic->win_width, vic->win_height);
	}
	pthread_mutex_unlock(&bus->t_data->prg_mutex);
}

void	set_key(_keymap *keys, uint8_t row, uint8_t col, action_t act) {
	keys->matrix[row] = 0xFF;
	if (act) keys->matrix[row] &= ~(1 << col);
}

void	key_event_handle(_bus* bus, SDL_Event *event) {
	_keymap *keys = ((_CIA*)bus->cia1)->keys;
	key = event->key.key;
	
	switch (key) {
		case SDLK_KP_0: keydata.key = SDLK_0; break;
		case SDLK_KP_1: keydata.key = SDLK_1; break;
		case SDLK_KP_2: keydata.key = SDLK_2; break;
		case SDLK_KP_3: keydata.key = SDLK_3; break;
		case SDLK_KP_4: keydata.key = SDLK_4; break;
		case SDLK_KP_5: keydata.key = SDLK_5; break;
		case SDLK_KP_6: keydata.key = SDLK_6; break;
		case SDLK_KP_7: keydata.key = SDLK_7; break;
		case SDLK_KP_8: keydata.key = SDLK_8; break;
		case SDLK_KP_9: keydata.key = SDLK_9; break;
		case SDLK_KP_EQUALS: keydata.key = SDLK_EQUAL; break;
		case SDLK_LCTRL: keydata.key = SDLK_RCTRL; break;
		case SDLK_DELETE: keydata.key = SDLK_BACKSPACE; break;
		default:	break;
	}

	switch (keydata.key) {
		/* CTRL */
		case SDLK_ESCAPE: set_key(keys, 7, 7, keydata.action); break;
		case SDLK_RIGHT_SUPER: set_key(keys, 7, 5, keydata.action); break;
		case SDLK_BACKSPACE: set_key(keys, 0, 0, keydata.action); break;
		case SDLK_ENTER: set_key(keys, 0, 1, keydata.action); break;
		case SDLK_F1: set_key(keys, 0, 4, keydata.action); break;
		case SDLK_F2: set_key(keys, 0, 5, keydata.action); break;
		case SDLK_F5: set_key(keys, 0, 6, keydata.action); break;
		case SDLK_F7: set_key(keys, 0, 3, keydata.action); break;
		case SDLK_LEFT_SHIFT: set_key(keys, 1, 7, keydata.action); break;
		case SDLK_RIGHT_SHIFT: set_key(keys, 6, 4, keydata.action); break;
		case SDLK_RIGHT_CONTROL: set_key(keys, 7, 2, keydata.action); break;
		/* CURSOR ARROWS */
		case SDLK_RIGHT: set_key(keys, 0, 2, keydata.action); break;
		case SDLK_DOWN: set_key(keys, 0, 7, keydata.action); break;
		case SDLK_UP:
			         set_key(keys, 1, 7, keydata.action);
			         set_key(keys, 0, 7, keydata.action);
			         break;
		case SDLK_LEFT:
			         set_key(keys, 1, 7, keydata.action);
			         set_key(keys, 0, 2, keydata.action);
			         break;
		/* NUMS */
		case SDLK_1: set_key(keys, 7, 0, keydata.action); break;
		case SDLK_2: set_key(keys, 7, 3, keydata.action); break;
		case SDLK_3: set_key(keys, 1, 0, keydata.action); break;
		case SDLK_4: set_key(keys, 1, 3, keydata.action); break;
		case SDLK_5: set_key(keys, 2, 0, keydata.action); break;
		case SDLK_6: set_key(keys, 2, 3, keydata.action); break;
		case SDLK_7: set_key(keys, 3, 0, keydata.action); break;
		case SDLK_8: set_key(keys, 3, 3, keydata.action); break;
		case SDLK_9: set_key(keys, 4, 0, keydata.action); break;
		case SDLK_0: set_key(keys, 4, 3, keydata.action); break;
		/* ALPHA */
		case SDLK_Q: set_key(keys, 7, 6, keydata.action); break;
		case SDLK_W: set_key(keys, 1, 1, keydata.action); break;
		case SDLK_E: set_key(keys, 1, 6, keydata.action); break;
		case SDLK_R: set_key(keys, 2, 1, keydata.action); break;
		case SDLK_T: set_key(keys, 2, 6, keydata.action); break;
		case SDLK_Y: set_key(keys, 3, 1, keydata.action); break;
		case SDLK_U: set_key(keys, 3, 6, keydata.action); break;
		case SDLK_I: set_key(keys, 4, 1, keydata.action); break;
		case SDLK_O: set_key(keys, 4, 6, keydata.action); break;
		case SDLK_P: set_key(keys, 5, 1, keydata.action); break;
		case SDLK_A: set_key(keys, 1, 2, keydata.action); break;
		case SDLK_S: set_key(keys, 1, 5, keydata.action); break;
		case SDLK_D: set_key(keys, 2, 2, keydata.action); break;
		case SDLK_F: set_key(keys, 2, 5, keydata.action); break;
		case SDLK_G: set_key(keys, 3, 2, keydata.action); break;
		case SDLK_H: set_key(keys, 3, 5, keydata.action); break;
		case SDLK_J: set_key(keys, 4, 2, keydata.action); break;
		case SDLK_K: set_key(keys, 4, 5, keydata.action); break;
		case SDLK_L: set_key(keys, 5, 2, keydata.action); break;
		case SDLK_Z: set_key(keys, 1, 4, keydata.action); break;
		case SDLK_X: set_key(keys, 2, 7, keydata.action); break;
		case SDLK_C: set_key(keys, 2, 4, keydata.action); break;
		case SDLK_V: set_key(keys, 3, 7, keydata.action); break;
		case SDLK_B: set_key(keys, 3, 4, keydata.action); break;
		case SDLK_N: set_key(keys, 4, 7, keydata.action); break;
		case SDLK_M: set_key(keys, 4, 4, keydata.action); break;
		/* ARITHMATICS */
		case SDLK_KP_ADD: set_key(keys, 5, 0, keydata.action); break;
		case SDLK_KP_SUBTRACT: set_key(keys, 5, 3, keydata.action); break;
		case SDLK_KP_MULTIPLY: set_key(keys, 6, 1, keydata.action); break;
		case SDLK_EQUAL: set_key(keys, 6, 5, keydata.action); break;
		/* OTHER */
		case SDLK_APOSTROPHE: set_key(keys, 5, 5, keydata.action); break;
		case SDLK_PERIOD: set_key(keys, 5, 4, keydata.action); break;
		case SDLK_SLASH: set_key(keys, 6, 7, keydata.action); break;
		case SDLK_COMMA: set_key(keys, 5, 7, keydata.action); break;
		case SDLK_SPACE: set_key(keys, 7, 4, keydata.action); break;
		case SDLK_SEMICOLON: set_key(keys, 6, 2, keydata.action); break;
		default:	break;
	}
}

void	setup_mlx_hooks(void *p) {
	_bus *bus = (_bus*)p;
	_VIC_II *vic = (_VIC_II*)bus->vic;
	mlx_close_hook(vic->mlx_ptr, close_hook, bus);
	mlx_resize_hook(vic->mlx_ptr, resize_hook, bus);
	mlx_key_hook(vic->mlx_ptr, key_hook, bus);
	mlx_loop_hook(vic->mlx_ptr, loop_hook, bus);
}
